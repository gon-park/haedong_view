{% extends "chart_viewer/base.html" %}
{% load staticfiles %}

{% block contents %}
<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Futures Charts</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="btn-group">
                        <div class="input-group">
                            <input id="input_subject_code" type="text" class="form-control chart-header-input-sm">
                            <span class="input-group-addon chart-header-xs">
                                    <i class="fa fa-search"></i>
                                </span>
                        </div>
                    </div>

                    <div class="btn-group">
                        <input type="text" class="form-control chart-header-input-sm" readonly value="Gold">
                    </div>

                    <div class="btn-group">
                        <button id="btn_day" type="button" class="btn btn-default btn-xs">일</button>
                        <button id="btn_week" type="button" class="btn btn-default btn-xs">주</button>
                        <button id="btn_month" type="button" class="btn btn-default btn-xs">월</button>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-default btn-xs">분</button>
                        <button type="button" class="btn btn-default btn-xs">틱</button>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-default btn-xs">60</button>
                        <button type="button" class="btn btn-default btn-xs">120</button>
                        <div class="input-group">
                            <input type="text" class="form-control chart-header-input-xs" maxlength="3">
                            <span class="input-group-addon chart-header-xs">
                                    <i class="fa fa-check"></i>
                                </span>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" id="btnPrev" class="btn btn-default btn-xs"><i
                                class="fa fa-arrow-left"></i></button>
                        <button type="button" id="btnNext" class="btn btn-default btn-xs"><i
                                class="fa fa-arrow-right"></i></button>
                        <button type="button" class="btn btn-default btn-xs"><i class="fa fa-bar-chart"></i>
                        </button>
                    </div>

                    <div class="btn-group">
                        <div class='input-group date'>
                            <input type='text' class="form-control chart-header-input-m" id='fromDate'>
                            <span class="input-group-addon chart-header-xs">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                        </div>
                    </div>

                    <div class="btn-group">
                        ~
                    </div>

                    <div class="btn-group">
                        <div class='input-group date'>
                            <input type='text' class="form-control chart-header-input-m" id='toDate'>
                            <span class="input-group-addon chart-header-xs">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                        </div>
                    </div>
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">

                    <div id="container" style="height:600px;"></div>

                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
    </div>
    <!-- /.row -->
</div>


<script type="text/javascript">
    $(function () {
        $('#btnPrev').click(function () {
            $("#fromDate").datepicker("update", getDateByOffset($("#fromDate").datepicker('getDate').val(), -1));
        });
        $('#btnNext').click(function () {
            $("#toDate").datepicker("update", getDateByOffset($("#toDate").datepicker('getDate').val(), 1));
        });
        $('#input_subject_code').on("input", function () {
            var subject_code = $('#input_subject_code').val();

            $.ajax({
                method: 'GET',
                url: '/api/exist-table/' + subject_code,
                success: function (result) {
                    if (result == 'True') {
                        $('#input_subject_code').parent().removeClass('has-error');

                        $.ajax({
                            method: 'GET',
                            url: '/api/' + subject_code + '/date',
                            success: function(data) {
                                console.log(data);
                                var start_date = new Date(data.start_date);
                                var end_date = new Date(data.end_date);
                                console.log(start_date);
                                console.log(end_date);
                                $('#fromDate').datepicker({
                                    minDate: start_date,
                                    maxDate: end_date,
                                    autoclose: true,
                                });
                                $('#fromDate').datepicker('refresh');
                                $('#toDate').datepicker({
                                    minDate: start_date,
                                    maxDate: end_date,
                                    autoclose: true,
                                });
                                $('#toDate').datepicker('refresh');
                            }
                        });
                    } else {
                        $('#input_subject_code').parent().addClass('has-error');
                    }
                }
            });
        });
    });

    $('#btn_day').click(function () {
        request_chart();

        /*
        var i = 0, series = chart.series[0];
        }
        data = usdeur.splice(0, 100);
        }
        for (i; i < data.length; i += 1) {
        }
            {   series.addPoint(data[i], false);
            }
            {chart.redraw();
            }
        }
        */
        }
    );


    /*
    function callback(chart) {
        var series = chart.series[0],
            points = series.points,
            pLen = points.length,
            i = 0,
            lastIndex = pLen - 1,
            minIndex = series.processedYData.getIndexBy(2, series.dataMin),
            maxIndex = series.processedYData.getIndexBy(1, series.dataMin);

        points[minIndex].options.showLabel = true;
        points[maxIndex].options.showLabel = true;
        points[lastIndex].options.showLabel = true;
        series.isDirty = true;
        chart.redraw();
    }
    */

    function request_chart() {
        /* 유효성 체크 */
        if($('#fromDate') == undefined || $('#toDate') == undefined ||
            $('#fromDate').val() == '' || $('#toDate').val() == '')
            return;

        $.ajax({
            method: 'GET',
            url: '/get_chart/',
            data: {
                subject_code: $('#input_subject_code').val(),
                chart_type: 'tick',
                time_unit: 60,
                start_date: $('#fromDate').val(),
                end_date: $('#toDate').val(),
                indicators: [],
            },
            success: function (data) {
                render_chart(data);
            }
        });
    }

    function render_chart(data) {
        var candle = data.candles;
        var indicators = data.indicators;

        setTimestamp(candle);
        console.log(candle);

        // calc sma 30
        calcSma(candle, 30);
        calcSma(candle, 60);

        // create the chart
        Highcharts.setOptions({
            time: {
                useUTC: false
            }
        });
        Highcharts.stockChart('container', {
            rangeSelector: {
                allButtonsEnabled: true,
                buttons: [{
                    type: 'day',
                    count: 1,
                    text: 'Day'
                }, {
                    type: 'week',
                    count: 1,
                    text: 'Week'
                }, {
                    type: 'all',
                    text: 'Month'
                }],
                buttonTheme: {
                    width: 60
                },
                selected: 2
            },

            xAxis: {
                type: 'datetime',
                dateTimeLabelFormats: {
                    day: '%m/%e %H:%M'
                },
{#                plotBands: [#}
{#                    {#}
{#                        from: 1510527600000,#}
{#                        to: 1510742542000,#}
{#                        color: '#E6F9FF'#}
{#                    },#}
{#                    {#}
{#                        from: 1510742542000,#}
{#                        to: 1511742542000,#}
{#                        color: '#FFE5DB'#}
{#                    }#}
{#                ]#}
            },
            yAxis: {},
            plotOptions: {
                series: {
                    dataGrouping: {
                        enabled: false
                    }
                },
                candlestick: {
                    lineColor: 'black',
                    color: '#115BCB',
                    upColor: '#E71909',
                }
            },
            series: [{
                type: 'candlestick',
                name: 'Gold Candlestick',
                data: candle,
                dataGrouping: {
                    enabled: false
                }
            }, {
                type: 'line',
                name: 'MA 30',
                data: indicator.SMA[30],
                dataGrouping: {
                    enabled: false
                },
                color: 'red'
            }, {
                type: 'scatter',
                name: 'MA 60',
                data: indicator.SMA[60],
                dataGrouping: {
                    enabled: false
                },
                color: 'green',
                marker: {
                    radius: 1.5
                }
            }]
            //}, callback);
        });
    }

    function getDateByOffset(date, offset) {
        var _date = new Date(date);
        var _newDate = new Date();
        _newDate.setDate(_date.getDate() + offset);
        return _newDate;
    }

    function setTimestamp(candle) {
        for (var i = 1; i < candle.length; i++) {
            if (Math.round(candle[i][0] / 1000) == Math.round(candle[i - 1][0] / 1000)) {
                candle[i][0] = candle[i - 1][0] + 1;
            }
        }
    }

    function calcSma(candle, period) {
        var sum = 0;
        if (!(period in indicator.SMA)) indicator.SMA[period] = []

        for (var i = 0; i < candle.length; i++) {
            sum = sum + candle[i][4];
            value = []
            value[0] = candle[i][0];
            if (i >= period - 1) {
                value[1] = sum / period;
                sum -= (candle[i - period + 1][4]);
            } else {
                value[1] = null;
            }
            indicator.SMA[period][i] = value;
        }
    }

    Array.prototype.getIndexBy = function (name, value) {
        for (var i = 0; i < this.length; i++) {
            if (this[i][name] == value) {
                return i;
            }
        }
        return -1;
    }

    var indicator = {
        SMA: {},
    };

</script>

{% endblock %}